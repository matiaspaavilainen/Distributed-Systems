---
apiVersion: apps/v1
kind: StatefulSet
metadata:
    name: mongodb
    labels:
        app: mongodb
spec:
    serviceName: mongodb
    replicas: 4 # 3 workers + 1 control plane, matching Kafka
    selector:
        matchLabels:
            app: mongodb
    template:
        metadata:
            labels:
                app: mongodb
        spec:
            affinity:
                nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                        nodeSelectorTerms:
                            - matchExpressions:
                                  - key: node-role.kubernetes.io/control-plane
                                    operator: Exists
                                  - key: kafka-ordinal
                                    operator: In
                                    values:
                                        - "0" # Match control-plane with kafka-0
                            - matchExpressions:
                                  - key: node-role.kubernetes.io/worker
                                    operator: Exists
                                  - key: kafka-ordinal
                                    operator: In
                                    values:
                                        - "1" # Match workers with kafka-1,2,3
                                        - "2"
                                        - "3"
            containers:
                - name: mongodb
                  image: mongo:latest
                  ports:
                      - containerPort: 27017
                  env:
                      - name: MONGO_INITDB_ROOT_USERNAME
                        value: "root"
                      - name: MONGO_INITDB_ROOT_PASSWORD
                        value: "example"
                  volumeMounts:
                      - name: init-script
                        mountPath: /docker-entrypoint-initdb.d/
                        readOnly: true
            volumes:
                - name: init-script
                  configMap:
                      name: mongo-init-script
---
apiVersion: v1
kind: Service
metadata:
    name: mongodb
spec:
    clusterIP: None # Headless service for StatefulSet DNS
    selector:
        app: mongodb
    ports:
        - protocol: TCP
          port: 27017
          targetPort: 27017
